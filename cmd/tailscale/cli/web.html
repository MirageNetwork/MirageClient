<!doctype html>
<html class="bg-gray-50">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="shortcut icon"
		href="data:image/png;base64,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" />
	<title>蜃境</title>
	<style>{{template "web.css"}}</style>
</head>

<body class="py-14">
<main class="container max-w-lg mx-auto mb-8 py-6 px-8 bg-white rounded-md shadow-2xl" style="width: 95%">
	<header class="flex justify-between items-center min-width-0 py-2 mb-8">
		<svg width="26" height="26" viewBox="-50 -50 100 100" style="background-color: transparent;" xmlns="http://www.w3.org/2000/svg">
			<rect x="-48" y="-48" width="96" height="96" rx="15" fill="none"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(0 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="rgb(2,31,54)" transform="rotate(0 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(60 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="white" transform="rotate(60 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(120 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="rgb(2,31,54)" transform="rotate(120 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(180 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="white" transform="rotate(180 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(240 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="rgb(2,31,54)" transform="rotate(240 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(300 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="white" transform="rotate(300 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
		  
			<circle cx="0" cy="0" r="11" fill="white" stransform="rotate(0 0 0)" stroke-width="6.5" stroke="rgb(68,92,112)"/>
		  </svg>
		<div class="flex items-center justify-end space-x-2 w-2/3">
			{{ with .Profile }}
			<div class="text-right w-full leading-4">
				<h4 class="truncate leading-normal">{{.LoginName}}</h4>
				<div class="text-xs text-gray-500 text-right">
					<a href="#" class="hover:text-gray-700 js-loginButton">切换账户</a> | <a href="#"
						class="hover:text-gray-700 js-loginButton">重新登录</a> | <a href="#"
						class="hover:text-gray-700 js-logoutButton">登出</a>
				</div>
			</div>
			{{ end }}
			<div class="relative flex-shrink-0 w-8 h-8 rounded-full overflow-hidden">
				{{ with .Profile.ProfilePicURL }}
				<div class="w-8 h-8 flex pointer-events-none rounded-full bg-gray-200"
					style="background-image: url('{{.}}'); background-size: cover;"></div>
				{{ else }}
				<div class="w-8 h-8 flex pointer-events-none rounded-full border border-gray-400 border-dashed"></div>
				{{ end }}
			</div>
		</div>
	</header>
	{{ if .IP }}
	<div
		class="border border-gray-200 bg-gray-0 rounded-md p-2 pl-3 pr-3 width-full flex items-center justify-between">
		<div class="flex items-center min-width-0">
			<svg class="flex-shrink-0 text-gray-600 mr-3 ml-1" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
				viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
				stroke-linejoin="round">
				<rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
				<rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
				<line x1="6" y1="6" x2="6.01" y2="6"></line>
				<line x1="6" y1="18" x2="6.01" y2="18"></line>
			</svg>
			<div>
				<h4 class="font-semibold truncate mr-2">{{.DeviceName}}</h4>
			</div>
		</div>
		<h5>{{.IP}}</h5>
	</div>
	<p class="mt-1 ml-1 mb-6 text-xs text-gray-600">
		调试信息: 蜃境 {{ .IPNVersion }}, tun={{.TUNMode}}{{ if .IsSynology }}, DSM{{ .DSMVersion}}
			{{if not .TUNMode}}
			(出访问未开启: 请脚本或ssh执行 /var/packages/Mirage/target/bin/mirage configure-host; synosystemctl restart pkgctl-Mirage.service)
			{{end}}
		{{end}}
	</p>
	{{ end }}
	{{ if or (eq .Status "NeedsLogin") (eq .Status "NoState") }}
	{{ if .IP }}
	<div class="mb-6">
		<p class="text-gray-700">你的设备密钥已过期。再次登录以重新认证该设备。</p>
	</div>
	<a href="#" class="mb-4 js-loginButton" target="_blank">
		<button class="button button-blue w-full">再次登录</button>
	</a>
	{{ else }}
	<div class="mb-6">
		<h3 class="text-3xl font-semibold mb-3">登录</h3>
		<p class="text-gray-700">登录进你的蜃境网络以开始</p>
	</div>
	<label class="text-gray-500 mb-4 mr-2 text-sm">控制器地址</label>
	<input id="serverCode" class="mb-4 px-2 text-sm border rounded-md" placeholder="留空使用默认值"/>
	<a href="#" class="mb-4 js-loginKickButton" target="_blank">
		<button class="button button-blue w-full">登录</button>
	</a>
	{{ end }}
	{{ else if eq .Status "NeedsMachineAuth" }}
	<div class="mb-4">
		设备已认证，但在连接到网络前需要网络管理员的批准。
	</div>
	{{ else }}
	<div class="mb-4">
		<p>你已连接！在蜃境中通过上面的设备名或IP地址访问该设备。</p>
	</div>
	<div class="mb-4">
	<a href="#" class="mb-4 js-advertiseExitNode">
		{{if .AdvertiseExitNode}}
		<button class="button button-red button-medium" id="enabled">停止用作出口节点</button>
		{{else}}
		<button class="button button-blue button-medium" id="enabled">用作出口节点</button>
		{{end}}
	</a>
	</div>
	<div class="flex justify-between items-center">
		<label class="text-gray-500 mr-2 text-md">子网转发</label>	
		<input id="subnetSet" class="px-2 mr-2 text-md border rounded-md" value="{{.AdvertiseRoutes}}">
		<a href="#" class="js-advertiseRoutes">
			<button class="button button-blue text-xs">更新子网转发设置</button>
		</a>
	</div>
	{{ end }}
</main>
<footer class="container max-w-lg mx-auto text-center">
	<p class="text-xs text-gray-500 hover:text-gray-600">欢迎使用蜃境</p>
</footer>
<script>(function () {
const advertiseExitNode = {{ .AdvertiseExitNode }};
const isUnraid = {{ .IsUnraid }};
const unraidCsrfToken = "{{ .UnraidToken }}";
let fetchingUrl = false;
var data = {
	AdvertiseRoutes: "{{ .AdvertiseRoutes }}",
	AdvertiseExitNode: advertiseExitNode,
	Reauthenticate: false,
	ForceLogout: false
};

function postData(e) {
	e.preventDefault();

	if (fetchingUrl) {
		return;
	}

	fetchingUrl = true;
	const urlParams = new URLSearchParams(window.location.search);
	const token = urlParams.get("SynoToken");
	const nextParams = new URLSearchParams({ up: true });
	if (token) {
		nextParams.set("SynoToken", token)
	}
	const nextUrl = new URL(window.location);
	nextUrl.search = nextParams.toString()

	let body = JSON.stringify(data);
	let contentType = "application/json";

	if (isUnraid) {
		const params = new URLSearchParams();
		params.append("csrf_token", unraidCsrfToken);
		params.append("ts_data", JSON.stringify(data));

		body = params.toString();
		contentType = "application/x-www-form-urlencoded;charset=UTF-8";
	}

	const url = nextUrl.toString();
	fetch(url, {
		method: "POST",
		headers: {
			"Accept": "application/json",
			"Content-Type": contentType,
		},
		body: body
	}).then(res => res.json()).then(res => {
		fetchingUrl = false;
		const err = res["error"];
		if (err) {
			throw new Error(err);
		}
		const url = res["url"];
		if (url) {
			if(isUnraid) {
				window.open(url, "_blank");
			} else {
				document.location.href = url;
			}
		} else {
			location.reload();
		}
	}).catch(err => {
		alert("Failed operation: " + err.message);
	});
}
document.querySelectorAll(".js-loginButton").forEach(function (el){
	el.addEventListener("click", function(e) {
		data.ServerCode = "NOUPDATE";
		data.Reauthenticate = true;
		postData(e);
	});
})
document.querySelectorAll(".js-loginKickButton").forEach(function (el){
	el.addEventListener("click", function(e) {
		data.ServerCode = document.getElementById("serverCode").value;
		data.Reauthenticate = true;
		postData(e);
	});
})
document.querySelectorAll(".js-logoutButton").forEach(function(el) {
	el.addEventListener("click", function (e) {
		data.ForceLogout = true;
		postData(e);
	});
})
document.querySelectorAll(".js-advertiseExitNode").forEach(function (el) {
	el.addEventListener("click", function(e) {
		data.AdvertiseExitNode = !advertiseExitNode;
		postData(e);
	});
})
document.querySelectorAll(".js-advertiseRoutes").forEach(function (el) {
	el.addEventListener("click", function(e) {
		data.AdvertiseRoutes = document.getElementById("subnetSet").value;
		postData(e);
	});
})

})();</script>
</body>

</html>
