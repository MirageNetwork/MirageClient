<!doctype html>
<html class="bg-gray-50">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="shortcut icon"
		href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAHdElNRQflAx4QGA4EvmzDAAAA30lEQVRIx2NgGAWMCKa8JKM4A8Ovt88ekyLCDGOoyDBJMjExMbFy8zF8/EKsCAMDE8yAPyIwFps48SJIBpAL4AZwvoSx/r0lXgQpDN58EWL5x/7/H+vL20+JFxluQKVe5b3Ke5V+0kQQCamfoYKBg4GDwUKI8d0BYkWQkrLKewYBKPPDHUFiRaiZkBgmwhj/F5IgggyUJ6i8V3mv0kCayDAAeEsklXqGAgYGhgV3CnGrwVciYSYk0kokhgS44/JxqqFpiYSZbEgskd4dEBRk1GD4wdB5twKXmlHAwMDAAACdEZau06NQUwAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMC0wNy0xNVQxNTo1Mzo0MCswMDowMCVXsDIAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjAtMDctMTVUMTU6NTM6NDArMDA6MDBUCgiOAAAAAElFTkSuQmCC" />
	<title>蜃境</title>
	<style>{{template "web.css"}}</style>
</head>

<body class="py-14">
<main class="container max-w-lg mx-auto mb-8 py-6 px-8 bg-white rounded-md shadow-2xl" style="width: 95%">
	<header class="flex justify-between items-center min-width-0 py-2 mb-8">
		<svg width="26" height="26" viewBox="-50 -50 100 100" style="background-color: transparent;" xmlns="http://www.w3.org/2000/svg">
			<rect x="-48" y="-48" width="96" height="96" rx="15" fill="none"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(0 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="rgb(2,31,54)" transform="rotate(0 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(60 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="white" transform="rotate(60 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(120 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="rgb(2,31,54)" transform="rotate(120 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(180 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="white" transform="rotate(180 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(240 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="rgb(2,31,54)" transform="rotate(240 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
			<line x1="0" y1="0" x2="0" y2="-25" stroke-width="6.5" transform="rotate(300 0 0)" stroke="rgb(68,92,112)"/>
			<circle cx="0" cy="-35" r="9" fill="white" transform="rotate(300 0 0)" stroke-width="5.5" stroke="rgb(68,92,112)"/>
		  
			<circle cx="0" cy="0" r="11" fill="white" stransform="rotate(0 0 0)" stroke-width="6.5" stroke="rgb(68,92,112)"/>
		  </svg>
		<div class="flex items-center justify-end space-x-2 w-2/3">
			{{ with .Profile }}
			<div class="text-right w-full leading-4">
				<h4 class="truncate leading-normal">{{.LoginName}}</h4>
				<div class="text-xs text-gray-500 text-right">
					<a href="#" class="hover:text-gray-700 js-loginButton">切换账户</a> | <a href="#"
						class="hover:text-gray-700 js-loginButton">重新登录</a> | <a href="#"
						class="hover:text-gray-700 js-logoutButton">登出</a>
				</div>
			</div>
			{{ end }}
			<div class="relative flex-shrink-0 w-8 h-8 rounded-full overflow-hidden">
				{{ with .Profile.ProfilePicURL }}
				<div class="w-8 h-8 flex pointer-events-none rounded-full bg-gray-200"
					style="background-image: url('{{.}}'); background-size: cover;"></div>
				{{ else }}
				<div class="w-8 h-8 flex pointer-events-none rounded-full border border-gray-400 border-dashed"></div>
				{{ end }}
			</div>
		</div>
	</header>
	{{ if .IP }}
	<div
		class="border border-gray-200 bg-gray-0 rounded-md p-2 pl-3 pr-3 width-full flex items-center justify-between">
		<div class="flex items-center min-width-0">
			<svg class="flex-shrink-0 text-gray-600 mr-3 ml-1" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
				viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
				stroke-linejoin="round">
				<rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
				<rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
				<line x1="6" y1="6" x2="6.01" y2="6"></line>
				<line x1="6" y1="18" x2="6.01" y2="18"></line>
			</svg>
			<div>
				<h4 class="font-semibold truncate mr-2">{{.DeviceName}}</h4>
			</div>
		</div>
		<h5>{{.IP}}</h5>
	</div>
	<p class="mt-1 ml-1 mb-6 text-xs text-gray-600">
		调试信息: 蜃境 {{ .IPNVersion }}, tun={{.TUNMode}}{{ if .IsSynology }}, DSM{{ .DSMVersion}}
			{{if not .TUNMode}}
			(<a href="https://tailscale.com/kb/1152/synology-outbound/" class="link-underline text-gray-600" target="_blank"
				aria-label="Configure outbound synology traffic"
				rel="noopener noreferrer">出访问未开启</a>)
			{{end}}
		{{end}}
	</p>
	{{ end }}
	{{ if or (eq .Status "NeedsLogin") (eq .Status "NoState") }}
	{{ if .IP }}
	<div class="mb-6">
		<p class="text-gray-700">你的设备密钥已过期。再次登录以重新认证该设备。</p>
	</div>
	<a href="#" class="mb-4 js-loginButton" target="_blank">
		<button class="button button-blue w-full">再次登录</button>
	</a>
	{{ else }}
	<div class="mb-6">
		<h3 class="text-3xl font-semibold mb-3">登录</h3>
		<p class="text-gray-700">登录进你的蜃境网络以开始</p>
	</div>
	<a href="#" class="mb-4 js-loginButton" target="_blank">
		<button class="button button-blue w-full">登录</button>
	</a>
	{{ end }}
	{{ else if eq .Status "NeedsMachineAuth" }}
	<div class="mb-4">
		设备已认证，但在连接到网络前需要网络管理员的批准。
	</div>
	{{ else }}
	<div class="mb-4">
		<p>你已连接！在蜃境中通过上面的设备名或IP地址访问该设备。</p>
	</div>
	<div class="mb-4">
	<a href="#" class="mb-4 js-advertiseExitNode">
		{{if .AdvertiseExitNode}}
		<button class="button button-red button-medium" id="enabled">停止用作出口节点</button>
		{{else}}
		<button class="button button-blue button-medium" id="enabled">用作出口节点</button>
		{{end}}
	</a>
	</div>
	{{ end }}
</main>
<footer class="container max-w-lg mx-auto text-center">
	<p class="text-xs text-gray-500 hover:text-gray-600">欢迎使用蜃境</p>
</footer>
<script>(function () {
const advertiseExitNode = {{.AdvertiseExitNode}};
let fetchingUrl = false;
var data = {
	AdvertiseRoutes: "{{.AdvertiseRoutes}}",
	AdvertiseExitNode: advertiseExitNode,
	Reauthenticate: false,
	ForceLogout: false
};

function postData(e) {
	e.preventDefault();

	if (fetchingUrl) {
		return;
	}

	fetchingUrl = true;
	const urlParams = new URLSearchParams(window.location.search);
	const token = urlParams.get("SynoToken");
	const nextParams = new URLSearchParams({ up: true });
	if (token) {
		nextParams.set("SynoToken", token)
	}
	const nextUrl = new URL(window.location);
	nextUrl.search = nextParams.toString()
	const url = nextUrl.toString();

	fetch(url, {
		method: "POST",
		headers: {
			"Accept": "application/json",
			"Content-Type": "application/json",
		},
		body: JSON.stringify(data)
	}).then(res => res.json()).then(res => {
		fetchingUrl = false;
		const err = res["error"];
		if (err) {
			throw new Error(err);
		}
		const url = res["url"];
		if (url) {
			document.location.href = url;
		} else {
			location.reload();
		}
	}).catch(err => {
		alert("Failed operation: " + err.message);
	});
}

document.querySelectorAll(".js-loginButton").forEach(function (el){
	el.addEventListener("click", function(e) {
		data.Reauthenticate = true;
		postData(e);
	});
})
document.querySelectorAll(".js-logoutButton").forEach(function(el) {
	el.addEventListener("click", function (e) {
		data.ForceLogout = true;
		postData(e);
	});
})
document.querySelectorAll(".js-advertiseExitNode").forEach(function (el) {
	el.addEventListener("click", function(e) {
		data.AdvertiseExitNode = !advertiseExitNode;
		postData(e);
	});
})

})();</script>
</body>

</html>
